function displayMenu(){$("#form-section").load("/reportes/partial-view/menu")}function displayForm(e){currentReportTypeId=e;const a=`/reportes/partial-view/formulario?tipoReporteId=${e}`;$("#body-modal").load(a,null,onFormularioLoadedCompleted)}function displayTable(){const e="/reportes/partial-view/ultimos-reportes";$("#table-section").load(e,function(){$.fn.DataTable.isDataTable("table.reportes-table")&&$("table.reportes-table").DataTable().clear().destroy(),$("table.reportes-table").DataTable({paging:!1,ordering:!0,scrollX:!0,fixedColumns:{right:1},buttons:["copy","excel","pdf"],layout:{topStart:"",topEnd:""},language:{url:"https://cdn.datatables.net/plug-ins/2.3.4/i18n/es-MX.json"},info:!1})})}function onFormularioLoadedCompleted(e,a,t){$("#Observaciones").trumbowyg({svgPath:"../img/svg/icons.svg",btns:[["formatting"],["strong","em","del"],["superscript","subscript"],["link"],["base64"],["justifyLeft","justifyCenter","justifyRight","justifyFull"],["unorderedList","orderedList"],["emoji"]]}),modal.show()}function submitNuevoReporte(e){e.preventDefault();const a=document.getElementById("submit-button"),t=a.querySelector(".upload-icon"),o=a.querySelector(".upload-spinner");a.disabled=!0,t.classList.add("d-none"),o.classList.remove("d-none");const s="/reportes",n="POST",l=$(e.target);$("span.text-danger").text(""),$.ajax({url:s,type:n,data:l.serialize(),success:function(e){modal.hide();var{folio:a}=e;Swal.fire({title:"Reporte almacenado",text:`Folio: ${a}`,icon:"success",confirmButtonText:"Aceptar"}).then(e=>{window.location.reload()})},error:function(e,a,t){if(console.error(e,t),422==e.status){const{errors:a}=e.responseJSON;a.forEach(e=>{const a=$(`span[data-valmsg-for="${e.field}"]`);a.text(e.message)})}else{let a="Error no controlado al registrar la entrada";if(e.responseJSON){const{title:t}=e.responseJSON;t&&(a=t)}Swal.fire({title:a,icon:"error"})}},complete:function(){a.disabled=!1,t.classList.remove("d-none"),o.classList.add("d-none")}})}function uploadAttachFile(e){const a="/reportes/upload-attach-file",t=e.target;if(0===t.files.length)return;const o=10485760;if(t.files[0].size>o)return Swal.fire({title:"Archivo demasiado grande",text:"El archivo debe ser menor a 10MB.",icon:"error"}),void(t.value="");const s=document.getElementById("upload-label"),n=s.querySelector(".upload-icon"),l=s.querySelector(".upload-spinner");n.classList.add("d-none"),l.classList.remove("d-none");const r=new FormData;r.append("file",t.files[0]),$.ajax({url:a,type:"POST",data:r,processData:!1,contentType:!1,success:function(e){Swal.fire({title:"Archivo subido",text:"El archivo se ha subido correctamente.",icon:"success"}),appendUploadedFile(e)},error:function(e,a,t){if(console.error(e,t),422==e.status){const{errors:a}=e.responseJSON;a.forEach(e=>{const a=$(`span[data-valmsg-for="${e.field}"]`);a.text(e.message)})}else Swal.fire({title:"Error al subir el archivo",text:t,icon:"error"})},complete:function(){setTimeout(()=>{n.classList.remove("d-none"),l.classList.add("d-none")},500)}})}function appendUploadedFile(e){const{fileName:a,originalFileName:t}=e;var o=t.length>120?t.slice(0,120)+"...":t,s=`<li class='list-box__item'><p><span>${o}</span></p></li>`;document.querySelector("ul#attachFiles");$("ul#attachFiles").append(s);const n=document.querySelector("#hiddenFileInputs"),l=$("ul#attachFiles li").length-1,r=document.createElement("input");r.type="hidden",r.name=`UploadedFiles[${l}][GuidName]`,r.value=a;const i=document.createElement("input");i.type="hidden",i.name=`UploadedFiles[${l}][OriginalName]`,i.value=t,n.appendChild(r),n.appendChild(i)}async function getHashAndSave(){const e=await fetch("/api/reportes/ultimos-reportes-hash");if(!e.ok)throw new Error(e.statusText);return await e.text()}function mostrarMapa(e,a){modalMapa.show(),maps.addMarker(e,a)}let intervalId=null,modalMapa=void 0;var maps={map:void 0,default_lat:19.922385,default_lon:-96.826112,init:(e,a)=>{let t=!1;if(e&&a){t=!0;var o=new google.maps.LatLng(e,a),s=17}else o=new google.maps.LatLng(maps.default_lat,maps.default_lon),s=7;o=e&&a?new google.maps.LatLng(e,a):new google.maps.LatLng(maps.default_lat,maps.default_lon);var n={center:o,zoom:s,scrollwheel:!1,mapId:"eticket_reportes_map_id"};if(maps.map=new google.maps.Map(document.getElementById("mapa"),n),t){const e=new google.maps.marker.AdvancedMarkerElement({map:maps.map,position:o,title:""});e.setMap(maps.map)}},addMarker:(e,a)=>{maps.map&&maps.map.markers?(maps.map.markers.forEach(e=>e.setMap(null)),maps.map.markers=[]):maps.map.markers=[];const t=new google.maps.marker.AdvancedMarkerElement({map:maps.map,position:new google.maps.LatLng(e,a),title:""});t.setMap(maps.map),maps.map.markers.push(t),maps.map.setCenter(new google.maps.LatLng(e,a)),maps.map.setZoom(14)}};jQuery(document).ready(function(){document.getElementById("mapa-modal")&&(maps.init(null,null),modalMapa=new bootstrap.Modal(document.getElementById("mapa-modal"))),displayMenu(),displayTable(),setInterval(async function(){try{const e=await getHashAndSave();ultimosReportesHash!==e&&(ultimosReportesHash=e,displayTable())}catch(e){clearInterval(intervalId),console.error(e)}},3e3),document.getElementsByClassName("nuevo-reporte-modal").length&&(modal=new bootstrap.Modal(document.getElementById("nuevo-reporte-modal")))});